#import "RCTViewSnapshotter.h"

@interface RCTUIManager (Private2)
- (void)createView:(nonnull NSNumber *)reactTag
          viewName:(NSString *)viewName
           rootTag:(__unused NSNumber *)rootTag
             props:(NSDictionary *)props;
- (void)setChildren:(nonnull NSNumber *)containerTag
          reactTags:(NSArray<NSNumber *> *)reactTags;
- (void)removeRootView:(nonnull NSNumber *)rootReactTag;
- (void)removeSubviewsFromContainerWithID:(nonnull NSNumber *)containerID;

@end

@implementation RCTViewSnapshotter

RCT_EXPORT_MODULE();

+ (instancetype)sharedInstance {
  static RCTViewSnapshotter *sharedViewSnapshotter = nil;
  @synchronized(self) {
    if (sharedViewSnapshotter == nil)
      sharedViewSnapshotter = [self new];
  }
  return sharedViewSnapshotter;
}

- (instancetype)init
{
  self = [super init];
  if (self) {
    self.viewSnapshots = [@[] mutableCopy];
  }
  return self;
}

- (void)snapshotView:(nonnull NSNumber *)reactTag
            viewName:(NSString *)viewName
             rootTag:(__unused NSNumber *)rootTag
               props:(NSDictionary *)props
{
  [self.viewSnapshots addObject:@{
                                  @"type": @"create",
                                  @"reactTag": reactTag,
                                  @"viewName": viewName,
                                  @"rootTag": rootTag,
                                  @"props": props ?: [NSNull null]
                                  }];
}

- (void)snapshotSetChildren:(nonnull NSNumber *)containerTag
                  reactTags:(NSArray<NSNumber *> *)reactTags
{
  [self.viewSnapshots addObject:@{
                                 @"type": @"setChildren",
                                 @"containerTag": containerTag,
                                 @"reactTags": reactTags
                                  }];
}


RCT_EXPORT_METHOD(saveSnapshot)
{
  NSData *jsonData = [NSJSONSerialization dataWithJSONObject:[RCTViewSnapshotter sharedInstance].viewSnapshots options:NSJSONWritingPrettyPrinted error:NULL];
  NSString *jsonString = [[NSString alloc] initWithData:jsonData encoding:NSUTF8StringEncoding];
  
  NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
  NSString *documentsDirectory = [paths objectAtIndex:0];
  NSString *path = [documentsDirectory stringByAppendingPathComponent:@"view-snapshot.json"];
  [jsonString writeToFile:path atomically:YES encoding:NSUTF8StringEncoding error:NULL];
  NSLog(@"Wrote snapshot to %@ with %lu items", path, (unsigned long)[RCTViewSnapshotter sharedInstance].viewSnapshots.count);
}

RCT_EXPORT_METHOD(didStartJsRendering)
{
  if ([RCTViewSnapshotter sharedInstance].didLoadSnapshot) {
    dispatch_async(RCTGetUIManagerQueue(), ^{
      [[RCTViewSnapshotter sharedInstance].uiManager removeRootView:[RCTViewSnapshotter sharedInstance].rootViewID];
    });
    [RCTViewSnapshotter sharedInstance].didLoadSnapshot = NO;
  }
}

@end
